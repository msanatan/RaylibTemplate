name: Build Raylib Game

on: [push]

env:
  RAYLIB_VERSION: 4.2.0
  GAME_NAME: ${{ github.event.repository.name }}

jobs:
  build-mac:
    runs-on: macos-12
    if: contains(github.event.head_commit.message, 'skip-mac') == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      # Mac installation of Raylib is similar, but we need to copy the static library and headers into the repo
      - name: Install Raylib on Mac
        run: |
          curl -L https://github.com/raysan5/raylib/releases/download/${{ env.RAYLIB_VERSION }}/raylib-${{ env.RAYLIB_VERSION }}_macos.tar.gz --output raylib.tar.gz
          tar -xzvf raylib.tar.gz
          cp raylib-${{ env.RAYLIB_VERSION }}_macos/lib/* .
          cp raylib-${{ env.RAYLIB_VERSION }}_macos/include/* ./src
      # We build with our specific CI build command, which statically links Raylib
      - name: Build on Mac
        run: make build-mac-ci
      # We then zip the game, this is needed in Mac so the final .app file is executable
      - name: Zip game build on Mac
        run: cd build && zip -r ${{ env.GAME_NAME }}.zip *
      # Upload the artifacts for each OS
      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.GAME_NAME }}-${{ env.RUNNER_OS }}
          path: build/${{ env.GAME_NAME }}.zip

  build-win:
    runs-on: windows-2022
    if: contains(github.event.head_commit.message, 'skip-win') == false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      # We download the prepackaged version of Raylib that works for the 64bit MinGW compiler
      - name: Install Raylib on Windows
        run: |
          curl -L https://github.com/raysan5/raylib/releases/download/${{ env.RAYLIB_VERSION }}/raylib-${{ env.RAYLIB_VERSION }}_win64_mingw-w64.zip --output raylib.zip
          7z x raylib.zip -oraylibwrapper
          mv raylibwrapper\raylib-${{ env.RAYLIB_VERSION }}_win64_mingw-w64 raylib
      # We build with our specific CI build command, which statically links Raylib
      # First, we set the WORKSPACE_DIR environment variable to the current directory, but with the correct path separators
      - name: Build on Windows
        run: |
          $env:WORKSPACE_DIR = ${env:GITHUB_WORKSPACE}.Replace("/", "\").Replace("\", "\\")
          make build-win-ci
      # We then zip the game with 7z as it's already installed in the shared runner
      - name: Zip game build on Mac
        run: cd build && 7z a -tzip ${{ env.GAME_NAME }}.zip *
      # Upload the artifacts for each OS
      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.GAME_NAME }}-${{ env.RUNNER_OS }}
          path: build/${{ env.GAME_NAME }}.zip
